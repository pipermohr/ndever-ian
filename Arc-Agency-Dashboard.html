import React, { useState, useEffect } from 'react';

// Main App Component for Arc Realty Dashboard
function App() {
  const [objectives, setObjectives] = useState([]);
  const [automations, setAutomations] = useState([]);
  const [kpis, setKpis] = useState({
    ytd_revenue: { value: 0, source: '' },
    active_agents: { value: 0, source: '' },
    new_agents_this_quarter: { value: 0, source: '' },
    avg_agent_productivity: { value: '', source: '' },
  });
  // Renamed coachMessages to copilotMessages and setCoachMessages to setCopilotMessages
  const [copilotMessages, setCopilotMessages] = useState([]);
  const [upcomingTasks, setUpcomingTasks] = useState([]);
  const [reviews, setReviews] = useState([]);
  const [teamMembers, setTeamMembers] = useState([]);

  // Growth & Operational Scores
  const [objectiveScore, setObjectiveScore] = useState(0);
  const [ndeverScore, setNdeverScore] = useState(0);
  const [todaysGrowthPoints, setTodaysGrowthPoints] = useState(0);
  const [objectiveScoreHistory, setObjectiveScoreHistory] = useState([]);


  // --- Helper Functions ---
  const greeting_by_time = () => {
    const hour = new Date().getHours();
    if (hour < 12) return "Good morning";
    if (hour < 18) return "Good afternoon";
    return "Good evening";
  };

  const formatCurrency = (value) => {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
  };

  const formatPercentage = (value) => {
    return new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(value);
  };

  // Calculate the overall Objective Score (weighted average of progress)
  const calculateOverallObjectiveScore = (objs) => {
      if (!objs || objs.length === 0) return 0;
      let totalWeightedProgress = 0;
      let totalWeight = 0;
      objs.forEach(obj => {
          totalWeightedProgress += (obj.progress * (obj.weight || 1));
          totalWeight += (obj.weight || 1);
      });
      return totalWeight === 0 ? 0 : Math.round(totalWeightedProgress / totalWeight);
  };

  // Determine the Objective Score Trend
  const getObjectiveScoreTrend = (history) => {
      if (history.length < 2) return "Stable";
      const latestScore = history[history.length - 1];
      const previousScore = history[history.length - 2];

      if (latestScore > previousScore) {
          return "Upward";
      } else if (latestScore < previousScore) {
          return "Downward";
      } else {
          return "Stable";
      }
  };


  useEffect(() => {
    // Simulate fetching initial dashboard data
    const fetchDashboardData = () => {
      const mockObjectives = [
        {
          id: 'agency_obj1',
          name: 'Achieve $5M Gross Commission Income (GCI)',
          status: 'on_track',
          progress: 72,
          weight: 5,
          metrics_definition: {
            gci_target: { type: 'currency', label: 'GCI Target' },
            current_gci: { type: 'currency', label: 'Current GCI' },
            active_listings: { type: 'number', label: 'Active Listings' },
          },
          current_values: {
            gci_target: 5000000,
            current_gci: 3600000,
            active_listings: 150,
          },
          target_values: {
            gci_target: 5000000,
            active_listings: 200,
          },
        },
        {
          id: 'hr_obj1',
          name: 'Onboard 10 New Real Estate Agents per Quarter',
          status: 'on_track',
          progress: 80,
          weight: 4,
          metrics_definition: {
            onboarding_target: { type: 'number', label: 'Agents Target' },
            current_onboarded: { type: 'number', label: 'Onboarded Agents' },
            avg_onboarding_time: { type: 'days', label: 'Avg. Onboarding Time' },
          },
          current_values: {
            onboarding_target: 10,
            current_onboarded: 8,
            avg_onboarding_time: 25,
          },
          target_values: {
            onboarding_target: 10,
            avg_onboarding_time: 20,
          },
        },
        {
          id: 'agency_obj2',
          name: 'Increase Agent Productivity (Avg. Transactions/Agent)',
          status: 'at_risk',
          progress: 55,
          weight: 3,
          metrics_definition: {
            transactions_per_agent_target: { type: 'number', label: 'Txns/Agent Target' },
            current_transactions_per_agent: { type: 'number', label: 'Current Txns/Agent' },
            agent_training_completion: { type: 'percentage', label: 'Training Comp. Rate' },
          },
          current_values: {
            transactions_per_agent_target: 3.0,
            current_transactions_per_agent: 2.2,
            agent_training_completion: 0.75,
          },
          target_values: {
            transactions_per_agent_target: 3.0,
            agent_training_completion: 0.90,
          },
        },
      ];
      setObjectives(mockObjectives);

      setKpis({
        ytd_revenue: { value: 3800000, source: 'Brokerage ERP' },
        active_agents: { value: 75, source: 'HRIS/Agent Roster' },
        new_agents_this_quarter: { value: 8, source: 'HRIS' },
        avg_agent_productivity: { value: '2.2 Txns/QTR', source: 'CRM/MLS Data' },
      });

      setAutomations([
        {
          id: 'auto1',
          name: 'New Agent Onboarding Workflow',
          status: 'Active',
          executions_today: 1,
          executions_this_week: 3,
          type: 'onboarding_flow',
          last_executed: '2025-06-17T09:00:00Z',
          integration_source: 'HRIS & DocuSign'
        },
        {
          id: 'auto2',
          name: 'Client Follow-up Sequence (Post-Sale)',
          status: 'Active',
          executions_today: 12,
          executions_this_week: 60,
          type: 'email_sequence',
          last_executed: '2025-06-17T11:00:00Z',
          integration_source: 'CRM & Marketing Automation'
        },
        {
          id: 'auto3',
          name: 'Agent Training & Compliance Reminders',
          status: 'Active',
          executions_today: 5,
          executions_this_week: 25,
          type: 'notification_series',
          last_executed: '2025-06-16T15:00:00Z',
          integration_source: 'LMS & Internal Ndever'
        },
      ]);

      // Updated coach messages to refer to "Mechelle"
      setCopilotMessages([
        { sender: 'coach', text: "Good morning, Mechelle! Your GCI objective is on track. We've successfully onboarded 8 new agents this quarter! Your average agent productivity is at 2.2 transactions per quarter. Shall we focus on boosting agent training completion?" },
        { sender: 'user', text: "Morning! Yes, let's prioritize agent productivity. What's the best playbook for experienced agents to increase their transactions?" },
        { sender: 'coach', text: "Understood. I've highlighted the 'Advanced Agent Marketing Playbook' and the 'Client Conversion Mastery Playbook'. I've also scheduled automated follow-ups for agents who haven't completed their Q2 compliance training." },
      ]);

      setUpcomingTasks([
        { id: 'task1', name: 'Review Q2 Agent Performance Reports', dueDate: 'End of Week', playbook: { title: 'Agent Performance' } },
        { id: 'task2', name: 'Schedule onboarding orientation for new agent Maria', dueDate: 'Tomorrow', playbook: { title: 'Agent Onboarding' } },
        { id: 'task3', name: 'Finalize Q3 marketing campaign budget', dueDate: 'Fri, Jun 21', playbook: { title: 'Marketing Strategy' } },
      ]);

      setReviews([
        { id: 'google', name: 'Google Reviews', rating: 4.8, count: 320, link: 'https://google.com/arcrealty' },
        { id: 'zillow', name: 'Zillow Premier Agent', rating: 4.9, count: 180, link: 'https://zillow.com/arcrealty-profile' },
        { id: 'yelp', name: 'Yelp Reviews', rating: 4.5, count: 75, link: 'https://yelp.com/arcrealty' },
      ]);

      // Mock data for team members
      setTeamMembers([
        { id: 'agent1', name: 'Sarah Chen', role: 'Agent', status: 'Active', performance: '5 deals this QTR' },
        { id: 'w2_emp1', name: 'David Lee', role: 'Operations Manager', status: 'Active', performance: 'Streamlining processes' },
        { id: 'agent2', name: 'Mike Johnson', role: 'Agent', status: 'Active', performance: 'Consistent performer' },
        { id: 'w2_emp2', name: 'Emily White', role: 'Marketing Specialist', status: 'Active', performance: 'Developing Q3 campaigns' },
      ]);

      // Calculate and set the new scores
      const calculatedObjectiveScore = calculateOverallObjectiveScore(mockObjectives);
      setObjectiveScore(calculatedObjectiveScore);
      setNdeverScore(1550);
      setTodaysGrowthPoints(90);

      setObjectiveScoreHistory([70, 72, 75, 77, 79, 81, calculatedObjectiveScore]);
    };

    fetchDashboardData();
  }, []);


  // --- React Components for Dashboard Elements ---

  const Icon = ({ name, className }) => {
    const icons = {
      "hero-scale": (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M10.125 12.75l-1.108 1.107A.75.75 0 018.842 14v-.825a2.25 2.25 0 00-2.25-2.25H4.125m11.25 0h-.825a2.25 2.25 0 00-2.25 2.25v.825c0 .211-.081.416-.226.561l-1.108 1.107c-.42.42-.647 1-.647 1.636v.433a2.25 2.25 0 002.25 2.25h.825m0-15l1.108-1.107A.75.75 0 0115.158 10V10.825a2.25 2.25 0 002.25 2.25h1.625M9.75 3.75v.825a2.25 2.25 0 002.25 2.25h.825m0-4.5L12 3.75l-1.108 1.107A.75.75 0 0010.842 5V5.825a2.25 2.25 0 00-2.25 2.25H4.125" />
        </svg>
      ),
      "hero-sparkles": (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 3a.75.75 0 01.75.75v16.5a.75.75 0 01-1.5 0V3.75A.75.75 0 0112 3zm.75 14.25l4.303 2.656a.75.75 0 001.233-.696l-1.02-4.839 3.636-3.486a.75.75 0 00-.435-1.32l-4.82-.587-2.288-4.478a.75.75 0 00-1.353.001L8.71 8.874l-4.82.587a.75.75 0 00-.435 1.32l3.636 3.486-1.02 4.839a.75.75 0 001.233.696L12 17.25z" />
        </svg>
      ),
      "hero-arrow-trending-up": (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18L9 11.25l4.303 4.303 7.084-7.084m0 0H18.75M21.75 5.25V7.5" />
          </svg>
      ),
      "hero-arrow-trending-down": (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 6L9 12.75l4.303-4.303 7.084 7.084m0 0H18.75M21.75 18.75V16.5" />
          </svg>
      ),
      "hero-arrows-left-right": (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className={className}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M7.5 12h9m-9 3.75H12M18.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
          </svg>
      ),
      "hero-fire": (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 22.5 12 13.5H3.75z" />
        </svg>
      ),
      "hero-star": (
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" className={className}>
          <path fillRule="evenodd" d="M10.868 2.884c.321-.772 1.415-.772 1.736 0l1.82 4.394a1.625 1.625 0 011.213.882l4.394 1.82c.772.321.772 1.415 0 1.736l-4.394 1.82a1.625 1.625 0 01-1.213.882l-1.82 4.394c-.321.772-1.415.772-1.736 0l-1.82-4.394a1.625 1.625 0 01-1.213-.882l-4.394-1.82c-.772-.321-.772-1.415 0-1.736l4.394-1.82a1.625 1.625 0 011.213-.882l1.82-4.394z" clipRule="evenodd" />
        </svg>
      ),
       "hero-check": (
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M4.5 12.75l6 6 9-13.5" />
        </svg>
      ),
       "hero-users": (
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className={className}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M15 19.125l-7.5-7.5 7.5-7.5" />
            <path strokeLinecap="round" strokeLinejoin="round" d="M10.25 15l-3-3 3-3" />
            <path strokeLinecap="round" strokeLinejoin="round" d="M14.25 9l3 3-3 3" />
            <path strokeLinecap="round" strokeLinejoin="round" d="M12 21a9 9 0 110-18 9 9 0 010 18z" />
         </svg>
       )
    };
    return icons[name] || null;
  };

  // ObjectiveScoreLineChart Component
  const ObjectiveScoreLineChart = ({ data, trend }) => {
    if (!data || data.length < 2) {
      return (
        <div className="text-center text-gray-500 text-sm mt-4">
          Not enough data for trend.
        </div>
      );
    }

    const width = 200;
    const height = 60;
    const margin = { top: 5, right: 5, bottom: 5, left: 5 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    const minScore = 0;
    const maxScore = 100;
    const xInterval = chartWidth / (data.length - 1);

    const points = data.map((d, i) => {
      const x = i * xInterval;
      const y = chartHeight - ((d - minScore) / (maxScore - minScore)) * chartHeight;
      return `${x},${y}`;
    }).join(' ');

    let trendIcon = null;
    let trendColor = "text-gray-500";
    if (trend === "Upward") {
        trendIcon = <Icon name="hero-arrow-trending-up" className="w-5 h-5" />;
        trendColor = "text-green-500";
    } else if (trend === "Downward") {
        trendIcon = <Icon name="hero-arrow-trending-down" className="w-5 h-5" />;
        trendColor = "text-red-500";
    } else {
        trendIcon = <Icon name="hero-arrows-left-right" className="w-5 h-5" />;
    }

    return (
      <div className="relative mt-4">
        <svg width={width} height={height}>
          <polyline
            fill="none"
            stroke="var(--color-info-600)"
            strokeWidth="2"
            points={points}
          />
           <circle cx={xInterval * (data.length - 1)} cy={chartHeight - ((data[data.length - 1] - minScore) / (maxScore - minScore)) * chartHeight} r="3" fill="var(--color-info-600)" />
        </svg>
        <div className={`absolute bottom-0 right-0 flex items-center text-xs font-semibold ${trendColor}`}>
          {trendIcon}
          <span className="ml-1">{trend} Trend</span>
        </div>
      </div>
    );
  };


  const MetricDisplay = ({ definition, value, target }) => {
    let displayValue = value;
    if (definition.type === 'currency') displayValue = formatCurrency(value);
    if (definition.type === 'percentage') displayValue = formatPercentage(value);
    if (definition.type === 'days') displayValue = `${value} days`;
    if (definition.type === 'number') displayValue = value.toLocaleString();

    let targetDisplay = target;
    if (target !== undefined) {
        if (definition.type === 'currency') targetDisplay = formatCurrency(target);
        if (definition.type === 'percentage') targetDisplay = formatPercentage(target);
        if (definition.type === 'days') targetDisplay = `${target} days`;
        if (definition.type === 'number') targetDisplay = target.toLocaleString();
    }

    return (
      <div className="flex justify-between text-sm text-gray-700">
        <span>{definition.label}: <span className="font-semibold">{displayValue}</span></span>
        {target !== undefined && <span className="text-gray-500">Target: {targetDisplay}</span>}
      </div>
    );
  };

  const ObjectiveCard = ({ objective }) => {
    const statusColor = {
      'on_track': 'bg-[var(--color-success-100)] text-[var(--color-success-800)]',
      'at_risk': 'bg-[var(--color-warning-100)] text-[var(--color-warning-800)]',
      'behind': 'bg-[var(--color-danger-100)] text-[var(--color-danger-800)]',
      'completed': 'bg-[var(--color-info-100)] text-[var(--color-info-800)]',
    };

    return (
      <div className="bg-white p-4 rounded-lg shadow-sm mb-4">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-lg font-semibold text-gray-800">{objective.name}</h3>
          <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColor[objective.status]}`}>
            {objective.status.replace('_', ' ').charAt(0).toUpperCase() + objective.status.replace('_', ' ').slice(1)}
          </span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-2.5 mb-2">
          <div className="bg-[var(--color-primary-500)] h-2.5 rounded-full" style={{ width: `${objective.progress}%` }}></div>
        </div>
        <p className="text-sm text-gray-600 mb-3">{objective.progress}% Progress</p>
        <div className="space-y-1">
          {Object.keys(objective.metrics_definition).map((key) => (
            <MetricDisplay
              key={key}
              definition={objective.metrics_definition[key]}
              value={objective.current_values[key]}
              target={objective.target_values[key]}
            />
          ))}
        </div>
      </div>
    );
  };

  const AutomationCard = ({ automation }) => {
    return (
      <div className="flex items-center justify-between bg-white p-3 rounded-lg shadow-sm text-gray-700 mb-2">
        <div>
          <h4 className="font-medium text-gray-800">{automation.name}</h4>
          <p className="text-xs text-gray-500">Last run: {new Date(automation.last_executed).toLocaleTimeString()}</p>
          {automation.integration_source && (
            <p className="text-xs text-gray-500 mt-1">
              <span className="font-medium text-gray-600">Source:</span> {automation.integration_source}
            </p>
          )}
        </div>
        <div className="text-right">
          <p className="text-sm font-semibold">{automation.executions_today} Today</p>
          <p className="text-xs text-gray-600">{automation.executions_this_week} This Week</p>
        </div>
      </div>
    );
  };

  const KPICard = ({ title, value, source }) => {
    return (
      <div className="bg-white p-5 rounded-lg shadow-sm flex flex-col items-start">
        <span className="text-sm text-gray-500">{title}</span>
        <span className="text-2xl font-bold text-[var(--color-primary-700)]">{value}</span>
        {source && <span className="text-xs text-gray-500 mt-1">Source: {source}</span>}
      </div>
    );
  };

  const ReviewSourceCard = ({ review }) => {
    return (
      <a href={review.link} target="_blank" rel="noopener noreferrer" className="block bg-white p-4 rounded-lg shadow-sm flex items-center space-x-3 hover:shadow-md transition-shadow">
        <Icon name="hero-star" className="w-6 h-6 text-yellow-500 flex-shrink-0" />
        <div className="flex-1">
          <p className="text-sm font-medium text-gray-800">{review.name}</p>
          <div className="flex flex-col text-xs text-gray-600">
            <span className="font-bold">{review.rating} Stars</span>
            <span className="text-gray-500">({review.count} reviews)</span>
          </div>
        </div>
      </a>
    );
  };

  const todaysGrowthWinsData = [
      { id: 'win1', title: "New Agent Emily finished onboarding early", playbook: { title: "Agent Onboarding" }, completed_at: new Date(Date.now() - 30 * 60 * 1000) },
      { id: 'win2', title: "Agent David closed a high-value property deal", playbook: { title: "Deal Closure Playbook" }, completed_at: new Date(Date.now() - 2 * 60 * 60 * 1000) },
      { id: 'win3', title: "Marketing team launched Q3 lead gen campaign", playbook: { title: "Marketing Strategy" }, completed_at: new Date(Date.now() - 5 * 60 * 60 * 1000) }
  ];

  const TeamMemberCard = ({ member }) => (
    <div className="bg-white p-3 rounded-lg shadow-sm flex items-center space-x-3">
      <div className="w-10 h-10 rounded-full bg-[var(--color-secondary-200)] flex items-center justify-center text-[var(--color-secondary-800)] font-bold flex-shrink-0">
        {member.name.charAt(0).toUpperCase()}
      </div>
      <div className="flex-1">
        <p className="text-sm font-medium text-gray-800">{member.name}</p>
        <p className="text-xs text-gray-500">{member.role} - {member.performance}</p>
      </div>
    </div>
  );


  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-900">
      {/* Ndever Branding CSS Variables */}
      <style>
        {`
          :root {
            --color-primary-50: #eff6ff;
            --color-primary-100: #dbeafe;
            --color-primary-200: #bfdbfe;
            --color-primary-500: #3b82f6;
            --color-primary-600: #2563eb;
            --color-primary-700: #1d4ed8;
            --color-primary-900: #1e3a8a;

            --color-info-50: #f0f9ff;
            --color-info-100: #e0f2fe;
            --color-info-500: #0ea5e9;
            --color-info-600: #0284c7;
            --color-info-700: #0369a1;
            --color-info-900: #0c4a6e;

            --color-success-50: #f0fdf4;
            --color-success-100: #dcfce7;
            --color-success-600: #22c55e;
            --color-success-800: #16a34a;

            --color-warning-100: #fff7ed;
            --color-warning-800: #c2410c;

            --color-danger-100: #fee2e2;
            --color-danger-800: #b91c1c;

            --color-secondary-100: #f3e8ff;
            --color-secondary-200: #e9d5ff;
            --color-secondary-700: #7e22ce;
            --color-secondary-800: #6b21a8;
          }
        `}
      </style>

      {/* Header */}
      <header className="bg-white shadow-sm p-4 flex justify-between items-center border-b border-gray-200">
        <div className="flex items-center">
          {/* Fixed: Updated image src for GitHub Pages deployment */}
          <img src="/ndever-ian/Logo-Color@2x.png" alt="Ndever Logo" className="h-8 w-auto mr-4" onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/120x32/white/ed8622/white?text=Ndever+Logo'; }} />
          <h1 className="text-xl font-semibold text-gray-800">Arc Realty Dashboard</h1>
        </div>
        <div className="flex items-center space-x-4">
          <span className="text-gray-600">Hi, Mechelle!</span>
          <div className="w-10 h-10 rounded-full bg-[var(--color-info-200)] flex items-center justify-center text-[var(--color-info-800)] font-bold">M</div>
        </div>
      </header>

      <main className="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Header Section */}
        <div className="lg:col-span-3 mb-8">
          <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-2">
            {greeting_by_time()}, Arc Realty Team!
          </h1>
          <p className="text-lg text-gray-600 dark:text-gray-400 mb-3">
            Your Ndever growth journey in progress.
          </p>
        </div>

        {/* Growth Overview Scores (Objective Score, Ndever Score, Today's Growth Wins) */}
        <div className="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          {/* Objective Score Card */}
          <div className="bg-gradient-to-br from-[var(--color-info-50)] to-[var(--color-info-100)] shadow-sm ring-1 ring-gray-900/5 rounded-xl p-6 relative overflow-hidden flex flex-col justify-between">
            <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-[var(--color-info-500)]/10 rounded-full blur-2xl"></div>
            <div className="relative flex items-center justify-between mb-4">
              <div className="w-10 h-10 bg-gradient-to-br from-[var(--color-info-500)] to-[var(--color-info-600)] rounded-lg flex items-center justify-center shadow-lg">
                <Icon name="hero-scale" className="w-5 h-5 text-white" />
              </div>
              <span className="text-xs font-semibold text-[var(--color-info-700)] uppercase tracking-wide">
                Objective Score
              </span>
            </div>
            <div className="relative">
              <p className="text-4xl font-bold text-[var(--color-info-900)] mb-2">
                {objectiveScore} / 100
              </p>
              <p className="text-sm text-[var(--color-info-700)] font-medium">
                Your real-time growth momentum across objectives.
              </p>
               {/* Line chart for Objective Score history */}
              <ObjectiveScoreLineChart data={objectiveScoreHistory} trend={getObjectiveScoreTrend(objectiveScoreHistory)} />
            </div>
          </div>

          {/* Ndever Score Card */}
          <div className="bg-gradient-to-br from-[var(--color-primary-50)] to-[var(--color-primary-100)] shadow-sm ring-1 ring-gray-900/5 rounded-xl p-6 relative overflow-hidden flex flex-col justify-between">
            <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-[var(--color-primary-500)]/10 rounded-full blur-2xl"></div>
            <div className="relative flex items-center justify-between mb-4">
              <div className="w-10 h-10 bg-gradient-to-br from-[var(--color-primary-500)] to-[var(--color-primary-600)] rounded-lg flex items-center justify-center shadow-lg">
                <Icon name="hero-sparkles" className="w-5 h-5 text-white" />
              </div>
              <span className="text-xs font-semibold text-[var(--color-primary-700)] uppercase tracking-wide">
                Ndever Score
              </span>
            </div>
            <div className="relative">
              <p className="text-4xl font-bold text-[var(--color-primary-900)] mb-2">
                {ndeverScore}
              </p>
              <p className="text-sm text-[var(--color-primary-700)] font-medium">
                Cumulative growth achievement. Next award at {ndeverScore + 250}!
              </p>
              <div className="w-full bg-[var(--color-primary-200)] rounded-full h-2 mt-2">
                <div className="bg-[var(--color-primary-600)] h-2 rounded-full" style={{ width: `${(ndeverScore % 250) / 2.5}%` }}></div>
              </div>
            </div>
          </div>

          {/* Today's Growth Wins Card */}
          <div className="bg-gradient-to-br from-[var(--color-success-50)] to-[var(--color-success-100)] shadow-sm ring-1 ring-gray-900/5 rounded-xl p-6 relative overflow-hidden flex flex-col justify-between">
            <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-[var(--color-success-500)]/10 rounded-full blur-2xl"></div>
            <div className="relative flex items-center justify-between mb-4">
              <div className="w-10 h-10 bg-gradient-to-br from-[var(--color-success-500)] to-[var(--color-success-600)] rounded-lg flex items-center justify-center shadow-lg">
                <Icon name="hero-fire" className="w-5 h-5 text-white" />
              </div>
              <span className="text-xs font-semibold text-[var(--color-success-700)] uppercase tracking-wide">
                Today's Growth Wins
              </span>
            </div>
            <div className="relative">
              <p className="text-4xl font-bold text-[var(--color-success-900)] mb-2">
                +{todaysGrowthPoints}
              </p>
              <p className="text-sm text-[var(--color-success-700)] font-medium">
                Points earned today. Keep up the momentum!
              </p>
            </div>
          </div>
        </div>

        <div className="lg:col-span-2 space-y-6">
          {/* Objectives Section */}
          <section className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Agency & Operational Objectives</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {objectives.map(obj => (
                <ObjectiveCard key={obj.id} objective={obj} />
              ))}
            </div>
          </section>

          {/* Team Overview Section */}
          <section className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
              <Icon name="hero-users" className="w-5 h-5 mr-2 text-gray-700" />
              Team Overview
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="bg-gray-100 p-4 rounded-lg text-center text-gray-700 font-semibold text-lg">
                    <span className="text-3xl font-bold text-[var(--color-primary-700)] mr-2">{kpis.active_agents.value}</span>
                    Active Agents
                </div>
                <div className="bg-gray-100 p-4 rounded-lg text-center text-gray-700 font-semibold text-lg">
                    <span className="text-3xl font-bold text-[var(--color-info-700)] mr-2">{kpis.new_agents_this_quarter.value}</span>
                    New Agents This QTR
                </div>
            </div>
            <div className="mt-4">
                <h3 className="text-lg font-medium text-gray-800 mb-3">Recent Agent Activity</h3>
                <div className="space-y-2">
                    {teamMembers.slice(0, 4).map(member => (
                        <TeamMemberCard key={member.id} member={member} />
                    ))}
                </div>
            </div>
          </section>


          {/* Upcoming Tasks */}
          <section className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Upcoming Agency Activities</h2>
            <ul className="space-y-3">
              {upcomingTasks.map(task => (
                <li key={task.id} className="flex items-center bg-gray-50 p-3 rounded-lg shadow-sm">
                  <input type="checkbox" className="form-checkbox h-5 w-5 text-[var(--color-primary-600)] rounded mr-3" />
                  <div className="flex-1">
                    <p className="text-base font-medium text-gray-800">{task.name}</p>
                    {task.playbook?.title && <p className="text-sm text-gray-500">Playbook: {task.playbook.title}</p>}
                    <p className="text-sm text-gray-500">{task.dueDate}</p>
                  </div>
                </li>
              ))}
            </ul>
          </section>

          {/* Recent Growth Wins */}
          {todaysGrowthWinsData.length > 0 && (
            <div className="bg-white shadow-sm ring-1 ring-gray-900/5 rounded-xl">
              <div className="px-6 py-4 border-b border-gray-200">
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-medium text-gray-900">
                    Recent Growth Wins
                  </h3>
                  <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-[var(--color-success-100)] text-[var(--color-success-800)]">
                    {todaysGrowthWinsData.length} completed
                  </span>
                </div>
              </div>
              <div className="p-6">
                <div className="space-y-3">
                  {todaysGrowthWinsData.map((win, index) => (
                    <div key={index} className="flex items-start space-x-3">
                      <div className="w-8 h-8 bg-[var(--color-success-100)] rounded-full flex items-center justify-center flex-shrink-0">
                        <Icon name="hero-check" className="w-4 h-4 text-[var(--color-success-600)]" />
                      </div>
                      <div className="flex-1">
                        <p className="text-sm text-gray-900">
                          {win.title}
                        </p>
                        <p className="text-xs text-gray-500 mt-1">
                          {win.playbook.title} • Completed{" "}
                          {new Date(win.completed_at).toLocaleDateString()}
                        </p>
                      </div>
                    </div>
                  ))}
                </div>
                {todaysGrowthWinsData.length >= 3 && (
                  <div className="mt-4 p-3 bg-[var(--color-success-50)] border border-[var(--color-success-200)] rounded-lg">
                    <p className="text-sm text-[var(--color-success-800)] font-medium">
                      <Icon name="hero-fire" className="w-4 h-4 inline mr-1" />
                      Outstanding progress in recent initiatives!
                    </p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Right Column: Ndever Coach, Automation Summary, Client Feedback */}
        <div className="space-y-6">
          {/* Ndever Co-Pilot Chat */}
          <section className="bg-white p-6 rounded-lg shadow-md h-96 flex flex-col">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Ndever Co-Pilot</h2>
            <div className="flex-1 overflow-y-auto border border-gray-200 p-3 rounded-lg bg-gray-50 mb-3 text-sm">
              {copilotMessages.map((msg, index) => (
                <div key={index} className={`mb-2 ${msg.sender === 'user' ? 'text-right' : 'text-left'}`}>
                  <span className={`inline-block p-2 rounded-lg ${
                    msg.sender === 'user' ? 'bg-[var(--color-primary-500)] text-white' : 'bg-gray-200 text-gray-800'
                  }`}>
                    {msg.text}
                  </span>
                </div>
              ))}
              <div className="text-gray-400 text-xs text-center mt-2">Ndever Co-Pilot is typing...</div>
            </div>
            <div className="flex">
              <input
                type="text"
                placeholder="Message Ndever Co-Pilot..."
                className="flex-1 border border-gray-300 p-2 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-primary-500)]"
              />
              <button className="bg-[var(--color-primary-600)] text-white p-2 rounded-r-lg hover:bg-[var(--color-primary-700)] transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                  <path strokeLinecap="round" strokeLinejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
              </button>
            </div>
          </section>

          {/* Workflow Automation Summary */}
          <section className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-bold text-gray-800 mb-4 flex items-center">
              Workflow Automations
              <span className="ml-2 px-2 py-1 bg-[var(--color-secondary-100)] text-[var(--color-secondary-700)] text-sm font-medium rounded-full">Active: {automations.length}</span>
            </h2>
            <div className="space-y-3">
              <div className="bg-gray-100 p-4 rounded-lg text-center text-gray-700 font-semibold text-lg">
                <span className="text-3xl font-bold text-[var(--color-secondary-700)] mr-2">
                    {automations.reduce((sum, auto) => sum + auto.executions_today, 0)}
                </span>Automations Executed Today
              </div>
              {automations.map(auto => (
                <AutomationCard key={auto.id} automation={auto} />
              ))}
            </div>
          </section>

          {/* Client Feedback & Reputation Section */}
          <section className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Client Feedback & Reputation</h2>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              {reviews.map(review => (
                <ReviewSourceCard key={review.id} review={review} />
              ))}
            </div>
          </section>
        </div>
      </main>
    </div>
  );
}

export default App;

        
